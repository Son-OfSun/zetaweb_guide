# Установка и обновление веб-части

## Установка веб-части

Первичная установка продукта требует ряда специализированных знаний и может быть выполнена самостоятельно при условии наличия определенной квалификации.

На сервере, где размещается ваш сайт, должен быть установлен IIS версии 7.0 и выше, .NET Framework версии 4.6.2 и выше, .NET Core Runtime 3.0.1 Hosting Bundle и выше, а также, должен быть доступен дистрибутив Zeta Web на одном из локальных дисков.

### Создание базы данных \(далее - БД\) сайта

Для создания базы необходимо выполнить следующую последовательность действий:

* Создайте чистую БД для сайта в MS SQL

Для этого запустите _**Microsoft SQL Server Managment Studio**_

![](../.gitbook/assets/image-26.png)

В левой части панели открывшегося окна, нажав правой кнопкой мыши на папку **Базы данных** необходимо выбрать **Создать базу данных,** а в поле **Имя базы данных** внести наименование сайта.

![](../.gitbook/assets/image-27.png)



* Восстановить созданную БД из резервную копию БД релиза \(файл расположен в каталоге DB дистрибутива с именем в формате x.x.x.x.bak»\)

{% hint style="info" %}
Динамический контент приводит к фрагментации таблиц БД, что, в свою очередь, прямо влияет на производительность сайта. 

Для поддержания производительности, а также для обеспечения сохранности данных в случае технического сбоя следует:

* Настроить регламентные операции по дефрагментации и реиндексации таблиц БД и таблиц статистик \([пример листинга таких операций приведен в разделе «Техническая документация»](../reglamentnye-operacii.md)\)
* Настроить план обслуживания по архивному копированию БД
{% endhint %}

### Размещение файлов сайта и настройка IIS

Для развертывания файлов сайта необходимо:

* Создать сайт в панели Диспетчер служб IIS \(в пуле должно быть выбрано .NET FrameWork, версии 4.0\)
* Разместить в папке сайта файлы из папки **cms** в поставке, дать на них доступ на изменение для пользователя «IIS\_IUSRS» на закладке Безопасность добавить пользователя и установить флаг Полный доступ.
* В созданном сайте \(IIS\) сконвертировать в приложение каталог **transferservice**, представляющую собой сервис обмена: -преобразовать в приложение

![](../.gitbook/assets/image%20%28567%29.png)

{% hint style="info" %}
Как правило, рекомендуется использовать отдельный пул для сервиса обмена сайта _\(например, создать отдельный пул "+exchange" к его имени\)_
{% endhint %}

* Перенести в корневую папку из папки configs файлы:

  * WebConnection.config
  * WebSettings.config

* Прописать в файле «WebConnection.config» пути доступа к SQL-базе сайта:

![](../.gitbook/assets/image%20%28273%29.png)

 

* Заполнить bindings именами доменов: - если их несколько

![](../.gitbook/assets/image%20%28280%29.png)

* Перезапустить сайт:

![](../.gitbook/assets/image%20%28243%29.png)

После выполненных действий необходимо перейти в 1С, установить [настройки параметров обмена с сайтом](nastroiki-saita-posle-zagruzki-nachalnykh-dannykh-i-tipovogo-dizaina.md) и произвести выгрузку данных.

### Установка API 2.0

* Скачать и установить с официального сайта microsoft .NET Core Hosting Bundle версии 3.0.1 и выше \([https://dotnet.microsoft.com/download/dotnet-core](https://dotnet.microsoft.com/download/dotnet-core)\)

![&#x418;&#x43D;&#x444;&#x43E;&#x440;&#x43C;&#x430;&#x446;&#x438;&#x43E;&#x43D;&#x43D;&#x43E;&#x435; &#x43E;&#x43A;&#x43D;&#x43E; &#x43E;&#x431; &#x443;&#x441;&#x43F;&#x435;&#x448;&#x43D;&#x43E;&#x439; &#x443;&#x441;&#x442;&#x430;&#x43D;&#x43E;&#x432;&#x43A;&#x435; .NET Core 2.2.5 WSH](../.gitbook/assets/image%20%28211%29.png)

* Открыть файл **WebSettings.config** в корневом каталоге приложения и добавить в конец файла следующую строку: 

```text
<add key="ApiUrl" value="/core" />
```

{% hint style="info" %}
В качестве значения атрибута **value** можно указать относительный или абсолютный путь к каталогу API 2.0. В приведенном примере указан относительный путь к каталогу API 2.0 по умолчанию: /core.
{% endhint %}

* Сохранить изменения в файле **WebSettings.config**

![&#x418;&#x437;&#x43C;&#x435;&#x43D;&#x435;&#x43D;&#x438;&#x44F; &#x432; &#x444;&#x430;&#x439;&#x43B;&#x435; WebSettings.config](../.gitbook/assets/image%20%28259%29.png)

* Добавить в каталог /core файл **connectionStrings.json**, в теле которого разместить следующий текст: 

```text
{
  "ConnectionStrings": {
    "ZetaWebInfrastructureDbContext": "Server=SSS;Database=DDD;Integrated Security=False;User Id=UUU;Password=PPP;MultipleActiveResultSets=true;"
  }
}
```

{% hint style="info" %}
Замените следующие параметры в указанном примере:

* **SSS** - адрес сервера БД
* **DDD** - имя базы данных сайта
* **UUU** - имя пользователя сервера БД
* **PPP** - пароль пользователя БД.
{% endhint %}

* Сохранить изменения в файле **connectionStrings.json**

![&#x41D;&#x430;&#x43F;&#x43E;&#x43B;&#x43D;&#x435;&#x43D;&#x438;&#x435; &#x444;&#x430;&#x439;&#x43B;&#x430; connectionStrings.json](../.gitbook/assets/image%20%28548%29.png)

* Создать новый Пул приложений \(Application Pool\) как указано на картинке ниже

![&#x421;&#x43E;&#x437;&#x434;&#x430;&#x43D;&#x438;&#x435; &#x43F;&#x443;&#x43B;&#x430; &#x43F;&#x440;&#x438;&#x43B;&#x43E;&#x436;&#x435;&#x43D;&#x438;&#x439; &#x434;&#x43B;&#x44F; API 2.0](../.gitbook/assets/image%20%28136%29.png)

* В созданном сайте \(IIS\) сконвертировать в приложение каталог **core**

![&#x41A;&#x43E;&#x43D;&#x432;&#x435;&#x440;&#x442;&#x430;&#x446;&#x438;&#x44F; &#x43A;&#x430;&#x442;&#x430;&#x43B;&#x43E;&#x433;&#x430; core &#x432; &#x43F;&#x440;&#x438;&#x43B;&#x43E;&#x436;&#x435;&#x43D;&#x438;&#x435;](../.gitbook/assets/image%20%28292%29.png)

* Указать в создаваемом приложении ранее созданный пул приложений

![&#x412;&#x44B;&#x431;&#x43E;&#x440; &#x43F;&#x443;&#x43B;&#x430; &#x43F;&#x440;&#x438;&#x43B;&#x43E;&#x436;&#x435;&#x43D;&#x438;&#x439; &#x434;&#x43B;&#x44F; &#x43F;&#x440;&#x438;&#x43B;&#x43E;&#x436;&#x435;&#x43D;&#x438;&#x44F; API 2.0](../.gitbook/assets/image%20%28139%29.png)

* Открыть описание API 2.0 для проверки правильности настроек по адресу: **имя\_вашего\_сайта/core/docs/index.html**

![&#x41E;&#x43F;&#x438;&#x441;&#x430;&#x43D;&#x438;&#x435; &#x43C;&#x435;&#x442;&#x43E;&#x434;&#x43E;&#x432; API 2.0 &#x432; &#x444;&#x43E;&#x440;&#x43C;&#x430;&#x442;&#x435; Swagger](../.gitbook/assets/image%20%28369%29.png)

{% hint style="warning" %}
Если что-то пошло не так...

После старта приложения в  каталоге /core/logs будет доступен файл с наименованием в формате yyyy-MM-dd.log.   
В данном файле содержатся описание процесса запуска приложения.J,y
{% endhint %}

## Обновление веб-части

* Запомнить текущую версию приложения 

{% hint style="info" %}
Посмотреть текущую версию приложения можно в файле **ChangeLog.txt**, расположенном корневой директории приложения.
{% endhint %}

* Скопировать на веб-сервер дистрибутив приложения
* Заменить файлы приложения на файлы, расположенные в папке **CMS.**
* Открыть главную страницу описания API 2.0 и дождаться ее отображения

{% hint style="info" %}
Если файлы  приложения API 2.0 расположены в каталоге **/core**, то адрес главной страницы будет таким: **имя\_вашего\_сайта/core/docs/index.htm**
{% endhint %}

{% hint style="info" %}
Изменения базы данных требуемые для работы нового релиза будут применены в автоматическом режиме.
{% endhint %}

### Дополнения к основным инструкциям

#### 2.4.10.1

При обновлении на релиз 2.4.10.1 и выше необходимо выполнить установку и настройку приложения API 2.0 \(см. инструкцию по установке\)

#### **2.4.11.0**

Перед обновлением на релиз 2.4.11.0 и выше на веб-сервере необходимо установить .NET Core Hosting Bundle версии 3.0.1 или выше \([https://dotnet.microsoft.com/download/dotnet-core/3.0](https://dotnet.microsoft.com/download/dotnet-core/3.0)\)



